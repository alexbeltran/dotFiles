#!/bin/bash
icon="$HOME/.xlock/icon.png"
tmpbg="/tmp/screen_$RANDOM.png"
tmptxt="/tmp/screen_txt_$RANDOM.png"
text="Type password to unlock"

scrot $tmpbg
convert $tmpbg -scale 10% -scale 1000% -fill black -colorize 25% $tmpbg

# Put a lock Icon on each display
# placement x/y
PX=0
PY=0

# lockscreen image info
R=$(file $icon | grep -o '[0-9]* x [0-9]*')
RX=$(echo $R | cut -d' ' -f 1)
RY=$(echo $R | cut -d' ' -f 3)

SR=$(xrandr --query | grep ' connected' | grep -v "LVDS" | cut -f3 -d' ')
for RES in $SR
do
    # monitor position/offset
    SRX=$(echo $RES | cut -d'x' -f 1)                   # x pos
    SRY=$(echo $RES | cut -d'x' -f 2 | cut -d'+' -f 1)  # y pos
    SROX=$(echo $RES | cut -d'x' -f 2 | cut -d'+' -f 2) # x offset
    SROY=$(echo $RES | cut -d'x' -f 2 | cut -d'+' -f 3) # y offset
    PX=$(($SROX + $SRX/2 - $RX/2))
    PY=$(($SROY + $SRY/2 - $RY/2))

    fontPX=$(($SROX + $SRX/2))
    fontPY=$(($SROY + $SRY/4))

    convert $tmpbg $icon -geometry +$PX+$PY -composite -matte $tmpbg 
	

	boX=$((SROX))
	barWidth=$((SRX))
	barHeight=$((boY + 30))
	boY=$((SROY + SRY - 60))

#	convert -fill white -draw "rectangle $boX,$boY $barWidth,$barHeight"  $tmpbg
#	convert -size $SRXx$SRY -fill white $tmpbg
#	convert $tmpbg -gravity center\
#        -font Nimbus-Sans-L -pointsize 26 -fill white\
#        -annotate +$fontPX+$fontPY "$text" $tmpbg
 
    convert -size $((barWidth))x60 xc:white -gravity center\
        -font Nimbus-Sans-L -pointsize 26 -fill black\
        -annotate +0,0 "$text" $tmptxt

	convert $tmptxt -alpha set -channel A -evaluate set 50% $tmptxt
	convert $tmpbg $tmptxt -geometry +$boX+$boY -composite $tmpbg
 

#	convert $tmpbg -size $SRXx$SRY canvas:white -geometry +$PX+$PY  -composite $tmpbg
#	echo +$SR)X+$SR0Y
done



i3lock -i $tmpbg 
rm $tmpbg $tmptxt
